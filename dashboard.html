<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>El Meu Panell de Cursos</title>
    <link rel="stylesheet" href="/css/estil.css">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        .course-card {
            border: 1px solid #ddd; border-radius: 8px; padding: 1rem;
            margin-top: 1rem; text-align: left; background-color: #f9f9f9;
        }
        .course-card a { text-decoration: none; font-size: 1.2rem; font-weight: bold; color: #003366; }
        .course-card p { margin-top: 0.5rem; font-size: 0.9rem; }
    </style>
</head>
<body>
    <nav data-netlify-identity-menu></nav>
    
    <main class="container">
        <h1>Els Meus Cursos</h1>
        <p>Aquests són els cursos als quals tens accés. Fes clic per començar.</p>
        <div id="courses-list">
            <p>Carregant els teus cursos...</p>
        </div>
    </main>
    
    <script>
        netlifyIdentity.on('init', user => {
            if (!user) {
                window.location.replace('/');
            } else {
                loadAllCourses();
            }
        });
        
        function loadAllCourses() {
            // =======================================================
            //  AQUÍ ESTÀ LA CORRECCIÓ
            // =======================================================
            fetch('/.netlify/functions/llistaCursos') 
            // =======================================================
            .then(response => {
                if(!response.ok) throw new Error('Error del servidor');
                return response.json()
            })
            .then(cursos => {
                const coursesListDiv = document.getElementById('courses-list');
                coursesListDiv.innerHTML = '';
                
                if (!cursos || cursos.length === 0) {
                    coursesListDiv.innerHTML = '<p>Encara no hi ha cursos disponibles.</p>';
                    return;
                }
                
                cursos.forEach(curs => {
                    const { titol, slug, descripcio } = curs.attributes;
                    const card = document.createElement('div');
                    card.className = 'course-card';
                    const simpleDesc = descripcio[0]?.children[0]?.text || '';
                    
                    card.innerHTML = `
                        <a href="/curs.html?slug=${slug}">${titol}</a>
                        <p>${simpleDesc}</p>
                    `;
                    coursesListDiv.appendChild(card);
                });
            })
            .catch(error => {
                console.error("Error al carregar la llista de cursos:", error);
                document.getElementById('courses-list').innerHTML = '<p>Hi ha hagut un error en carregar els cursos.</p>';
            });
        }
    </script>
</body>
</html>