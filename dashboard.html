<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>El Meu Panell de Cursos</title>
    <link rel="stylesheet" href="/css/estil.css">
    
    <!-- Carreguem el widget de Netlify aquí, al head -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <style>
        .course-card {
            border: 1px solid #ddd; border-radius: 8px; padding: 1rem;
            margin-top: 1rem; text-align: left; background-color: #f9f9f9;
            transition: box-shadow 0.2s;
        }
        .course-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .course-card a {
            text-decoration: none; font-size: 1.2rem;
            font-weight: bold; color: #003366;
        }
        .course-card p { margin-top: 0.5rem; font-size: 0.9rem; }
    </style>
</head>
<body>
    <nav data-netlify-identity-menu></nav>
    
    <main class="container">
        <h1>Els Meus Cursos</h1>
        <p>Aquests són els cursos als quals tens accés. Fes clic per començar.</p>
        <div id="courses-list">
            <p>Carregant els teus cursos...</p>
        </div>
    </main>
    
    <!-- ======================================================= -->
    <!--  INICI DEL BLOC DE CODI AMB LA MÀXIMA GARANTIA           -->
    <!-- ======================================================= -->
    <script>
        // Li diem al navegador: "Quan tota la pàgina, incloent TOTS els scripts externs,
        // s'hagi carregat completament, LLAVORS i només llavors, executa aquesta funció."
        window.addEventListener('load', () => {
        
            netlifyIdentity.on('init', user => {
                if (!user) {
                    window.location.replace('/');
                } else {
                    console.log('Accés permès per a:', user.email);
                    loadEnrolledCourses();
                }
            });
            
            function loadEnrolledCourses() {
                const user = netlifyIdentity.currentUser();
                // Ens assegurem que tenim l'usuari abans de demanar el token
                if(user) {
                    user.jwt().then(token => {
                        fetch('/.netlify/functions/cursosMatriculats', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        })
                        .then(response => {
                            if (!response.ok) {
                                // Si hi ha un error al backend, el mostrem per a depuració
                                return response.json().then(err => { throw new Error(err.error || 'Error del servidor') });
                            }
                            return response.json();
                        })
                        .then(cursos => {
                            const coursesListDiv = document.getElementById('courses-list');
                            coursesListDiv.innerHTML = '';
                            
                            if (!cursos || cursos.length === 0) {
                                coursesListDiv.innerHTML = '<p>Encara no estàs matriculat/da a cap curs.</p>';
                                return;
                            }
                            
                            cursos.forEach(curs => {
                                const card = document.createElement('div');
                                card.className = 'course-card';
                                card.innerHTML = `
                                    <a href="/curs.html?slug=${curs.slug}">${curs.titol}</a>
                                    <p>${curs.descripcio}</p>
                                `;
                                coursesListDiv.appendChild(card);
                            });
                        })
                        .catch(error => {
                            console.error("Error al carregar els cursos matriculats:", error);
                            document.getElementById('courses-list').innerHTML = `<p>Hi ha hagut un error al carregar els teus cursos: ${error.message}</p>`;
                        });
                    });
                }
            }
            
        }); // Final de l'esdeveniment window.load
    </script>
    <!-- ======================================================= -->
    <!--  FI DEL BLOC DE CODI                                      -->
    <!-- ======================================================= -->
</body>
</html>