document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('jwt') && !window.appIniciada) {
        window.iniciarApp();
    }
});

window.logoutApp = function() {
    localStorage.clear();
    window.location.href = 'index.html';
};

window.appIniciada = false;

window.iniciarApp = function() {
    if (window.appIniciada) return;
    window.appIniciada = true;

    console.log("ðŸš€ Iniciando SICAP App...");

    // 1. NavegaciÃ³n
    try {
        initNavigation();
    } catch (e) {
        console.error("âŒ Error NavegaciÃ³n:", e);
    }

    // 2. Cabecera (AquÃ­ arreglamos el botÃ³n RN)
    try {
        initHeader();
    } catch (e) {
        console.error("âŒ Error Header:", e);
    }

    // 3. Router
    const urlParams = new URLSearchParams(window.location.search);
    if (!urlParams.get('slug')) {
        window.showView('dashboard');
    } else {
        const dashView = document.getElementById('dashboard-view');
        const examView = document.getElementById('exam-view');
        if(dashView) dashView.style.display = 'none';
        if(examView) examView.style.display = 'flex';
    }
};

function initHeader() {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) return;

    // --- A. Pintar Iniciales y Textos ---
    let initials = "US";
    if (user.nombre) {
        initials = user.nombre.charAt(0) + (user.apellidos ? user.apellidos.charAt(0) : '');
    } else if (user.username) {
        initials = user.username.substring(0, 2);
    }

    const safeSetText = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    };

    safeSetText('user-initials', initials.toUpperCase());
    safeSetText('dropdown-username', user.nombre ? `${user.nombre} ${user.apellidos}` : user.username);
    safeSetText('dropdown-email', user.email);
    safeSetText('profile-avatar-big', initials.toUpperCase());
    safeSetText('profile-name-display', user.nombre ? `${user.nombre} ${user.apellidos}` : user.username);
    safeSetText('profile-dni-display', user.username);

    // --- B. LÃ³gica del BotÃ³n "RN" (CORREGIDA) ---
    const trigger = document.getElementById('user-menu-trigger');
    const menu = document.getElementById('user-dropdown-menu');

    if (trigger && menu) {
        console.log("âœ… BotÃ³n RN detectado y activado.");

        // 1. Limpiamos eventos previos clonando el elemento
        const newTrigger = trigger.cloneNode(true);
        trigger.parentNode.replaceChild(newTrigger, trigger);

        // 2. Recuperamos referencias tras el clonado
        const activeTrigger = document.getElementById('user-menu-trigger');
        // El menÃº estaba DENTRO del trigger, asÃ­ que hay que buscarlo dentro del nuevo nodo
        const activeMenu = activeTrigger.querySelector('.user-dropdown') || document.getElementById('user-dropdown-menu');

        // 3. Asignamos el evento CLICK
        activeTrigger.addEventListener('click', (e) => {
            // Detenemos la propagaciÃ³n para que el 'document' no lo cierre al instante
            e.stopPropagation(); 
            console.log("ðŸ–±ï¸ Click en RN recibido");

            // Alternamos la clase 'show'
            activeMenu.classList.toggle('show');
            
            // FUERZA BRUTA: Si CSS falla, usamos display inline
            if (activeMenu.classList.contains('show')) {
                activeMenu.style.display = 'block';
            } else {
                activeMenu.style.display = 'none';
            }
        });

        // 4. Cerrar al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!activeTrigger.contains(e.target)) {
                activeMenu.classList.remove('show');
                activeMenu.style.display = 'none'; // Asegurar cierre
            }
        });
        
        // 5. Evitar que clicks DENTRO del menÃº lo cierren (opcional, para links)
        activeMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // Reactivar links del menÃº (porque al clonar se perdieron)
        const links = activeMenu.querySelectorAll('a');
        if(links[0]) links[0].onclick = (e) => { e.preventDefault(); window.showView('profile'); activeMenu.style.display = 'none'; }; // Perfil
        if(links[1]) links[1].onclick = (e) => { e.preventDefault(); window.showView('grades'); activeMenu.style.display = 'none'; }; // Notas
        // Logout tiene su propio onclick en HTML, deberÃ­a funcionar, pero por si acaso:
        const logoutBtn = activeMenu.querySelector('#btn-logout-dropdown');
        if(logoutBtn) logoutBtn.onclick = window.logoutApp;
    }
}

function initNavigation() {
    const views = {
        home: document.getElementById('catalog-view'),
        dashboard: document.getElementById('dashboard-view'),
        profile: document.getElementById('profile-view'),
        grades: document.getElementById('grades-view'),
        exam: document.getElementById('exam-view')
    };

    window.showView = function(viewName) {
        Object.values(views).forEach(el => { if(el) el.style.display = 'none'; });
        if(views[viewName]) views[viewName].style.display = viewName === 'exam' ? 'flex' : 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        
        const activeMap = { 'home': 'nav-catalog', 'profile': 'nav-profile', 'dashboard': 'nav-dashboard' };
        if (activeMap[viewName]) document.getElementById(activeMap[viewName])?.classList.add('active');

        if(viewName === 'dashboard') loadUserCourses();
        if(viewName === 'home') loadCatalog();
        if(viewName === 'profile') loadFullProfile();
        if(viewName === 'grades') loadGrades();
    };

    const assignClick = (id, view) => {
        const btn = document.getElementById(id);
        if (btn) btn.onclick = (e) => { e.preventDefault(); window.showView(view); };
    };

    assignClick('nav-catalog', 'home');
    assignClick('nav-profile', 'profile');
    assignClick('nav-dashboard', 'dashboard');
}

// --- CARGA DE DATOS ---
async function loadUserCourses() {
    const list = document.getElementById('courses-list');
    const token = localStorage.getItem('jwt');
    const user = JSON.parse(localStorage.getItem('user'));
    if(!list || !token) return;
    list.innerHTML = '<div class="loader"></div>';
    try {
        const query = `filters[users_permissions_user][id][$eq]=${user.id}&populate[curs][populate]=imatge`;
        const res = await fetch(`${STRAPI_URL}/api/matriculas?${query}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const json = await res.json();
        list.innerHTML = '';
        if(!json.data || json.data.length === 0) { list.innerHTML = '<p style="text-align:center; padding:20px;">No tens cursos actius.</p>'; return; }
        json.data.forEach(mat => {
            const curs = mat.curs; if(!curs) return;
            let imgUrl = 'img/logo-sicap.png';
            if(curs.imatge) { const img = Array.isArray(curs.imatge) ? curs.imatge[0] : curs.imatge; if(img?.url) imgUrl = img.url.startsWith('/') ? STRAPI_URL + img.url : img.url; }
            const color = mat.progres >= 100 ? '#10b981' : 'var(--brand-blue)';
            list.innerHTML += `<div class="course-card-item"><div class="card-image-header" style="background-image: url('${imgUrl}');">${curs.etiqueta ? `<span class="course-badge">${curs.etiqueta}</span>` : ''}</div><div class="card-body"><h3 class="course-title">${curs.titol}</h3><div class="course-meta">${curs.hores || ''}</div><div class="progress-container"><div class="progress-bar"><div class="progress-fill" style="width:${mat.progres||0}%; background:${color}"></div></div><span class="progress-text">${mat.progres||0}% Completat</span></div><a href="index.html?slug=${curs.slug}" class="btn-primary" style="margin-top:auto; text-align:center;">Accedir</a></div></div>`;
        });
    } catch(e) { list.innerHTML = '<p style="color:red;">Error.</p>'; }
}

async function loadFullProfile() {
    const user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('jwt');
    document.getElementById('prof-email').value = user.email;
    try {
        const res = await fetch(`${STRAPI_URL}/api/afiliados?filters[dni][$eq]=${user.username}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const json = await res.json();
        if(json.data && json.data.length > 0) {
            const afi = json.data[0];
            const map = {'prof-movil': afi.TelefonoMobil, 'prof-prov': afi.Provincia, 'prof-pob': afi.Poblacion, 'prof-centre': afi.CentroTrabajo, 'prof-cat': afi.CategoriaProfesional, 'prof-dir': afi.Direccion, 'prof-iban': afi.IBAN};
            for (const [id, val] of Object.entries(map)) { const el = document.getElementById(id); if(el) el.value = val || '-'; }
        }
    } catch(e) {}
}
async function loadCatalog() { document.getElementById('catalog-list').innerHTML = '<p style="text-align:center; padding:20px;">No hi ha nous cursos.</p>'; }
async function loadGrades() { document.getElementById('grades-table-body').innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Sense dades.</td></tr>'; }