document.addEventListener('DOMContentLoaded', () => {
    // Solo iniciamos si hay token. Si auth.js ya lo inici√≥, esto act√∫a como fallback.
    if (localStorage.getItem('jwt') && !window.appIniciada) {
        window.iniciarApp();
    }
});

window.logoutApp = function() {
    localStorage.clear();
    window.location.href = 'index.html';
};

// Variable para evitar doble inicializaci√≥n
window.appIniciada = false;

window.iniciarApp = function() {
    if (window.appIniciada) return;
    window.appIniciada = true;

    console.log("üöÄ Iniciando SICAP App...");

    // 1. Inicializar Navegaci√≥n (Prioridad Alta)
    try {
        initNavigation();
        console.log("‚úÖ Navegaci√≥n lista");
    } catch (e) {
        console.error("‚ùå Error en Navegaci√≥n:", e);
    }

    // 2. Inicializar Cabecera y Usuario (Visual)
    try {
        initHeader();
        console.log("‚úÖ Cabecera cargada");
    } catch (e) {
        console.error("‚ùå Error en Header:", e);
    }

    // 3. Router inicial (Decidir qu√© ver)
    const urlParams = new URLSearchParams(window.location.search);
    if (!urlParams.get('slug')) {
        // Si no hay slug, forzamos la vista dashboard
        window.showView('dashboard');
    } else {
        // Si hay slug (curso), el renderitzadorCurs.js se encarga, 
        // pero necesitamos ocultar el dashboard base.
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('exam-view').style.display = 'flex';
    }
};

function initHeader() {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) return;

    // 1. Calcular Iniciales
    let initials = "US";
    if (user.nombre) {
        initials = user.nombre.charAt(0) + (user.apellidos ? user.apellidos.charAt(0) : '');
    } else if (user.username) {
        initials = user.username.substring(0, 2);
    }

    // 2. Rellenar Textos (Protegido contra nulos)
    const safeSetText = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    };

    safeSetText('user-initials', initials.toUpperCase());
    safeSetText('dropdown-username', user.nombre ? `${user.nombre} ${user.apellidos}` : user.username);
    safeSetText('dropdown-email', user.email);
    
    // Datos del perfil (si existen en el DOM)
    safeSetText('profile-avatar-big', initials.toUpperCase());
    safeSetText('profile-name-display', user.nombre ? `${user.nombre} ${user.apellidos}` : user.username);
    safeSetText('profile-dni-display', user.username);

    // 3. L√≥gica del Desplegable (SIN CLONE NODE para evitar perder referencias)
    const trigger = document.getElementById('user-menu-trigger');
    const menu = document.getElementById('user-dropdown-menu');

    if (trigger && menu) {
        // Eliminamos listeners viejos reasignando el onclick
        trigger.onclick = (e) => {
            e.stopPropagation(); // Evitar que el click llegue al document
            menu.classList.toggle('show');
        };

        // Listener global para cerrar al hacer click fuera
        // Usamos una propiedad en window para no a√±adir 100 listeners si se recarga
        if (!window.clickOutsideListenerAdded) {
            document.addEventListener('click', (e) => {
                if (menu.classList.contains('show') && !trigger.contains(e.target) && !menu.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });
            window.clickOutsideListenerAdded = true;
        }
    }
}

function initNavigation() {
    // Mapeo de Vistas
    const views = {
        home: document.getElementById('catalog-view'),
        dashboard: document.getElementById('dashboard-view'),
        profile: document.getElementById('profile-view'),
        grades: document.getElementById('grades-view'),
        exam: document.getElementById('exam-view')
    };

    window.showView = function(viewName) {
        console.log("Navegando a:", viewName);
        
        // Ocultar todas
        Object.values(views).forEach(el => {
            if(el) el.style.display = 'none';
        });

        // Mostrar seleccionada
        if(views[viewName]) {
            views[viewName].style.display = viewName === 'exam' ? 'flex' : 'block';
        }

        // Actualizar clases activas en men√∫
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        
        const activeMap = {
            'home': 'nav-catalog',
            'profile': 'nav-profile',
            'dashboard': 'nav-dashboard'
        };
        
        if (activeMap[viewName]) {
            const activeBtn = document.getElementById(activeMap[viewName]);
            if(activeBtn) activeBtn.classList.add('active');
        }

        // Cargar datos seg√∫n la vista
        if(viewName === 'dashboard') loadUserCourses();
        if(viewName === 'home') loadCatalog();
        if(viewName === 'profile') loadFullProfile();
        if(viewName === 'grades') loadGrades();
    };

    // Asignar eventos a botones (Protegido)
    const assignClick = (id, view) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.onclick = (e) => {
                e.preventDefault();
                window.showView(view);
            };
        }
    };

    assignClick('nav-catalog', 'home');
    assignClick('nav-profile', 'profile');
    assignClick('nav-dashboard', 'dashboard');

    // Enlaces del Dropdown
    const dropLinks = document.querySelectorAll('.user-dropdown ul li a');
    // Perfil
    if(dropLinks[0]) dropLinks[0].onclick = (e) => { e.preventDefault(); window.showView('profile'); };
    // Notas
    if(dropLinks[1]) dropLinks[1].onclick = (e) => { e.preventDefault(); window.showView('grades'); };
}

// --- FUNCIONES DE CARGA DE DATOS ---

async function loadUserCourses() {
    const list = document.getElementById('courses-list');
    const token = localStorage.getItem('jwt');
    const user = JSON.parse(localStorage.getItem('user'));

    if(!list || !token) return;
    
    list.innerHTML = '<div class="loader"></div>';

    try {
        // Filtramos matr√≠culas del usuario y traemos la imagen del curso
        const query = `filters[users_permissions_user][id][$eq]=${user.id}&populate[curs][populate]=imatge`;
        const res = await fetch(`${STRAPI_URL}/api/matriculas?${query}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const json = await res.json();
        
        list.innerHTML = '';
        
        if(!json.data || json.data.length === 0) {
            list.innerHTML = '<p style="text-align:center; padding:20px; width:100%;">No tens cursos actius actualment.</p>';
            return;
        }

        json.data.forEach(mat => {
            const curs = mat.curs;
            if(!curs) return;

            // Gesti√≥n de imagen segura
            let imgUrl = 'img/logo-sicap.png'; // Fallback
            if(curs.imatge) {
                const imgObj = Array.isArray(curs.imatge) ? curs.imatge[0] : curs.imatge;
                if(imgObj?.url) {
                    imgUrl = imgObj.url.startsWith('/') ? STRAPI_URL + imgObj.url : imgObj.url;
                }
            }

            const progressColor = mat.progres >= 100 ? '#10b981' : 'var(--brand-blue)';

            const card = document.createElement('div');
            card.className = 'course-card-item';
            card.innerHTML = `
                <div class="card-image-header" style="background-image: url('${imgUrl}');">
                    ${curs.etiqueta ? `<span class="course-badge">${curs.etiqueta}</span>` : ''}
                </div>
                <div class="card-body">
                    <h3 class="course-title">${curs.titol}</h3>
                    <div class="course-meta">${curs.hores || 'Durada N/A'}</div>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${mat.progres||0}%; background:${progressColor}"></div>
                        </div>
                        <span class="progress-text">${mat.progres||0}% Completat</span>
                    </div>
                    
                    <a href="index.html?slug=${curs.slug}" class="btn-primary" style="margin-top:auto; text-align:center;">Accedir</a>
                </div>
            `;
            list.appendChild(card);
        });

    } catch(e) {
        console.error(e);
        list.innerHTML = '<p style="color:red;">Error carregant cursos.</p>';
    }
}

async function loadFullProfile() {
    const user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('jwt');
    
    // Rellenar email del user standard
    const emailInput = document.getElementById('prof-email');
    if(emailInput) emailInput.value = user.email;

    try {
        const res = await fetch(`${STRAPI_URL}/api/afiliados?filters[dni][$eq]=${user.username}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const json = await res.json();

        if(json.data && json.data.length > 0) {
            const afi = json.data[0];
            // Mapeo ID input -> Campo API
            const map = {
                'prof-movil': afi.TelefonoMobil,
                'prof-prov': afi.Provincia,
                'prof-pob': afi.Poblacion,
                'prof-centre': afi.CentroTrabajo,
                'prof-cat': afi.CategoriaProfesional,
                'prof-dir': afi.Direccion,
                'prof-iban': afi.IBAN
            };

            for (const [id, val] of Object.entries(map)) {
                const el = document.getElementById(id);
                if(el) el.value = val || '-';
            }
        }
    } catch(e) {
        console.error("Error perfil", e);
    }
}

async function loadCatalog() {
    const list = document.getElementById('catalog-list');
    if(list) list.innerHTML = '<p style="text-align:center; padding:20px;">Actualment no hi ha nous cursos al cat√†leg.</p>';
}

async function loadGrades() {
    const body = document.getElementById('grades-table-body');
    if(body) body.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Sense dades.</td></tr>';
}